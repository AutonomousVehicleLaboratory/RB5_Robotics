
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="RB5 ROBOTICS TUTORIALS">
    <title>Archives - RB5 ROBOTICS TUTORIALS</title>
    <meta name="author" content="RB5 ROBOTICS TUTORIALS">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="Some description for subtitle">
<meta property="og:type" content="blog">
<meta property="og:title" content="RB5 ROBOTICS TUTORIALS">
<meta property="og:url" content="https://autonomousvehiclelaboratory.github.io/RB5_Robotics_Tutorials/archives/page/2/index.html">
<meta property="og:site_name" content="RB5 ROBOTICS TUTORIALS">
<meta property="og:description" content="Some description for subtitle">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="RB5 ROBOTICS TUTORIALS">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://autonomousvehiclelaboratory.github.io/RB5_Robotics_Tutorials/assets/images/avl-letters.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/RB5_Robotics_Tutorials/assets/css/style-64qguiewfoxvxmp0xtsq6t9zwhtgymxalbr3hofnf6gpcss5mvrocwased14.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/RB5_Robotics_Tutorials/"
            aria-label=""
        >
            RB5 ROBOTICS TUTORIALS
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /RB5_Robotics_Tutorials/#about"
            >
        
        
            <img class="header-picture" src="/RB5_Robotics_Tutorials/assets/images/avl-letters.png" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/RB5_Robotics_Tutorials/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/RB5_Robotics_Tutorials/assets/images/avl-letters.png" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">RB5 ROBOTICS TUTORIALS</h4>
                
                    <h5 class="sidebar-profile-bio"><p>A set of Robotics Tutorials developed for the RB5 Robotics Development Platform from Qualcomm. Authors are from the Contextual Robotics Institute at UC San Diego.</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/RB5_Robotics_Tutorials/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/RB5_Robotics_Tutorials/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/RB5_Robotics_Tutorials/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/AutonomousVehicleLaboratory"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:avl@eng.ucsd.edu"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/RB5_Robotics_Tutorials/2022/02/13/3%20Robotics%20Applications/april-tag-feature-detection/"
                            aria-label=": (2) April Tag Feature Detection"
                        >
                            (2) April Tag Feature Detection
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-02-13T17:12:21-08:00">
	
		    Feb 13, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/RB5_Robotics_Tutorials/categories/3-Robotics-Applications/">3 Robotics Applications</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>An important task in robotics is to uniquely identify features and landmarks over time as a robot navigates through the environment. The process can help estimate the robotics position (localization) to ultimately be able to perform robust path planning and navigation. In this tutorial, we will explore a popular open-source library for AprilTag detection and 3D pose estimation from a single monorcular camera. </p>
<p>AprilTags (shown in the figure below) are a form of fiducial markers that are designed with predefined sizes and patterns. The benefit of knowing their size is pose estimation given that a perspective mapping between two planes can be described by a Homography $\mathbf{H}$ matrix. In this case, $\mathbf{H}$ can describe a mapping between the camera frame and the marker since both can be assumed to be flat surfaces. This makes AprilTags an easy way of performing 3D pose estimation of objects with a single monocular camera by simply placing an AprilTag on the object. In addition, the unique pattern that defines each marker can help differentiate multiple markers that may be observable at a particular instance and by leveraging the concept of Hamming distance and dictionaries, error detection and correction can be performed in the event that part of a marker is occluded.</p>
<div class="figure " style="width:;"><img class="fig-img" src="apriltags.png" alt="Multiple AprilTag fiducial markers detected within an image with IDs 7 and 237. For marker 7, an error is detected and corrected. [1]"><span class="caption">Multiple AprilTag fiducial markers detected within an image with IDs 7 and 237. For marker 7, an error is detected and corrected. [1]</span></div>
<h2 id="The-AprilTag3-Library"><a href="#The-AprilTag3-Library" class="headerlink" title="The AprilTag3 Library"></a>The AprilTag3 Library</h2><p>Using the AprilTag library is actually quite simple and can be installed from <a target="_blank" rel="noopener" href="https://github.com/AprilRobotics/apriltag">source</a>. This includes compatible versions for C++ but also Python3. While our implementation will consist of C++, the Python version is even easier to get up and running. To install, simply run <code>pip install apriltag</code>.</p>
<p>For convenience, we have provided two implementations for AprilTag detection in ROS1 and ROS2. Given that both are C++ implementations, the logic remains the same. First, we convert our image to grayscale and populate a <code>image_u8_t</code> struct using the OpenCV <code>cv::Mat</code> image format. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat image_gray; </span><br><span class="line">cv::<span class="built_in">cvtColor</span>(image, image_gray, cv::COLOR_BGR2GRAY);</span><br><span class="line"></span><br><span class="line"><span class="type">image_u8_t</span> im = &#123; .width  = image_gray.cols,</span><br><span class="line">.height = image_gray.rows,</span><br><span class="line">.stride = image_gray.cols, </span><br><span class="line">.buf    = image_gray.data </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> Once the image has been converted to grayscale, we can instantiate an <code>apriltag_detection_t</code> instance and call <code>apriltag_detector_detect()</code>. This is the primary function incharge of performing marker detection on camera data. It is worth noting that this detection object can be reused so memory can be allocated in the class constructor of your implementation.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">apriltag_detector_t</span> *a_detector = <span class="built_in">apriltag_detector_create</span>();</span><br><span class="line"><span class="type">zarray_t</span> * detections = <span class="built_in">apriltag_detector_detect</span>(a_detector, &amp;im);</span><br></pre></td></tr></table></figure>

<p>As it can be seen, <code>apriltag_detector_detect()</code> returns an array of type <code>zarray_t</code> with the list of detections concatenated. In the following code block we extract individual detections into instances of type <code>apriltag_detection_t</code> and perform a perspective mapping using the homography matrix calculated. This is handled by <code>estimate_tag_pose()</code>. However, two important considerations include <em>i)</em> that we know the size of the markers in advance, and <em>ii)</em> we understand the intrinsic parameters of the camera that include image center and focal length. These are attributes that are part of the first argument of type <code>apriltag_detection_info_t</code> that is passed to <code>estimate_tag_pose()</code>. The marker size used in our implementation corresponds to $15.9cm$ and the camera parameters are estimated for the wide angle lens of the Qualcomm Robotics RB5 using the <a target="_blank" rel="noopener" href="https://docs.opencv.org/4.x/dc/dbb/tutorial_py_calibration.html">OpenCV calibration tool</a> and a standard checkerboard target.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">apriltag_detection_t</span> *det;</span><br><span class="line"><span class="type">apriltag_detection_info_t</span> tag_info; </span><br><span class="line">vector&lt;<span class="type">apriltag_pose_t</span>&gt; poses;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; ids;</span><br><span class="line"></span><br><span class="line">tag_info.tagsize = <span class="number">0.159</span>;</span><br><span class="line">tag_info.fx = <span class="number">663.57507</span>; </span><br><span class="line">tag_info.fy = <span class="number">694.47272</span>;</span><br><span class="line">tag_info.cx = <span class="number">956.22994</span>;</span><br><span class="line">tag_info.cy = <span class="number">539.54574</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="built_in">zarray_size</span>(detections); i++)&#123;</span><br><span class="line">  <span class="built_in">zarray_get</span>(detections, i, &amp;det);</span><br><span class="line">  tag_info.det = det;</span><br><span class="line">  <span class="type">apriltag_pose_t</span> pose;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// estimate SE(3) pose </span></span><br><span class="line">  <span class="built_in">estimate_tag_pose</span>(&amp;tag_info, &amp;pose);</span><br><span class="line">  poses.<span class="built_in">push_back</span>(pose);</span><br><span class="line">  ids.<span class="built_in">push_back</span>(det-&gt;id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The components described above have been wrapped into ROS1 and ROS2 implementations and be evaluated using the steps below.</p>
<h2 id="ROS1"><a href="#ROS1" class="headerlink" title="ROS1"></a>ROS1</h2><p>Create a workspace, clone the ROS1 implementation, and build the package. Make sure ROS is in your path, i.e. <code>source /opt/ros/melodic/setup.bash</code>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># install dependency</span><br><span class="line">apt install ros-melodic-apriltag</span><br><span class="line"></span><br><span class="line">mkdir -p rb5_ws/src &amp;&amp; cd rb5_ws/src</span><br><span class="line">git clone https://github.com/AutonomousVehicleLaboratory/rb5_ros.git</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line"># build all packages in the workspace</span><br><span class="line">catkin_make</span><br><span class="line">source devel/setup.bash</span><br><span class="line"></span><br><span class="line"># if the build all packages failed, try build only</span><br><span class="line">catkin_make --only-pkg-with-deps rb5_vision</span><br><span class="line">catkin_make --only-pkg-with-deps april_detection</span><br></pre></td></tr></table></figure>

<p>Start the camera node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roslaunch rb5_vision rb_camera_main_ocv.launch</span><br></pre></td></tr></table></figure>

<p>Start the AprilTag detection node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun april_detection april_detection_node</span><br></pre></td></tr></table></figure>



<h2 id="ROS2"><a href="#ROS2" class="headerlink" title="ROS2"></a>ROS2</h2><p>Create a workspace, clone the ROS2 implementation, and build the package. Make sure ROS is in your path, i.e. <code>source /opt/ros/dashing/setup.bash</code>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p rb5_ws/src &amp;&amp; cd rb5_ws/src</span><br><span class="line">git clone https://github.com/AutonomousVehicleLaboratory/rb5_ros2.git</span><br><span class="line">cd ..</span><br><span class="line">colcon build</span><br><span class="line">source rb5_ws/install/setup.bash </span><br></pre></td></tr></table></figure>

<p>Start the camera node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 launch rb5_ros2_vision rb_camera_main_ocv_launch.py</span><br></pre></td></tr></table></figure>

<p>Start the AprilTag detection node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run ros2_april_detection april_detection_node</span><br></pre></td></tr></table></figure>



<h2 id="Visualizing-the-markers-and-poses"><a href="#Visualizing-the-markers-and-poses" class="headerlink" title="Visualizing the markers and poses"></a>Visualizing the markers and poses</h2><p>For convenience, our ROS implementations publish messages of type <code>geometry_msgs::PoseArray</code> (<a target="_blank" rel="noopener" href="http://docs.ros.org/en/melodic/api/geometry_msgs/html/msg/PoseArray.html">ROS1</a>) and <code>geometry_msgs::msg::PoseStamped</code> (<a target="_blank" rel="noopener" href="https://docs.ros2.org/foxy/api/geometry_msgs/msg/PoseStamped.html">ROS2</a>). These messages are timestamped and include a unique ID that corresponds to the marker ID as part of the message header. Nonetheless, the main component of each is message is the marker’s pose in 3D which is represented as a position (a point) and orientation (here represented as a Quaternion). While we won’t go into the math component on how Quaternions are utilized to represent orientations in 3D space, ROS has an good tools for handling transformation and can handle transformations with ease. Below is a video of each marker being visualized using the 3D visualization tool for ROS called RViz. The video demos AprilTag3 detection and real-time 3D pose estimation running onboard of Qualcomm RB5.</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/qRoW6ljBfFo" frameborder="0" loading="lazy" allowfullscreen></iframe></div>


<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] <a target="_blank" rel="noopener" href="https://april.eecs.umich.edu/media/pdfs/olson2011tags.pdf">AprilTag: A robust and flexible visual fiducial system</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/RB5_Robotics_Tutorials/2022/02/13/3%20Robotics%20Applications/april-tag-feature-detection/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
          <li class="pagination-prev">
            <a
                class="btn btn--default btn--small"
                href="/RB5_Robotics_Tutorials/archives/"
                aria-label="NEWER POSTS"
            >
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span>NEWER POSTS</span>
            </a>
          </li>
        
        
        <li class="pagination-number">page 2 of 2</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 RB5 ROBOTICS TUTORIALS. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/RB5_Robotics_Tutorials/assets/images/avl-letters.png" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">RB5 ROBOTICS TUTORIALS</h4>
        
            <div id="about-card-bio"><p>A set of Robotics Tutorials developed for the RB5 Robotics Development Platform from Qualcomm. Authors are from the Contextual Robotics Institute at UC San Diego.</p>
</div>
        
        
            <div id="about-card-bio">
                <p>Contributors</p>

                <!-- <i class="fa fa-briefcase"></i>
                <br/> -->
                <p>Henrik I. Christensen, David Paz, Henry Zhang, Anirudh Ramesh.</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/RB5_Robotics_Tutorials/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/RB5_Robotics_Tutorials/assets/js/script-ouavugrvd9qj6lg3dktmularsze8hx0ahydxl4n9zvn5qystucng5rouil06.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
